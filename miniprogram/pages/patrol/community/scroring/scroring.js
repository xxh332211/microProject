"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const net_service_1 = require("../../../../service/net.service");
let interval = null;
Page({
    scoreList: {},
    data: {
        patrolData: {},
        scoring: {},
        scoring_index: 0,
    },
    bindKeyInput(e) {
        clearInterval(interval);
        interval = setTimeout(() => {
            let temp = this.data.scoring;
            let deduct_points = e.detail.value / 1;
            temp.detail[e.currentTarget.dataset.index].detail[e.currentTarget.dataset.i].deduct_points = deduct_points;
            this.setData({
                scoring: temp
            });
        }, 1000);
    },
    calcula(sub) {
        let total = sub.deduct_points / 1;
        sub.detail.forEach((element) => {
            total = element.deduct_points / 1 + total;
        });
        return total;
    },
    init() {
        net_service_1.default.getCurrentPenalties("community").then((res) => {
            this.setData({
                patrolData: res
            });
            this.setData({
                scoring_index: wx.getStorageSync('scoring_index'),
            });
            let scoring = this.data.patrolData.penalties[this.data.scoring_index];
            scoring.detail.forEach((element) => {
                element.deduct_points = 0;
            });
            scoring.deduct_points = 0;
            this.setData({
                scoring: scoring
            });
            console.log(this.data);
        });
    },
    onRemoveImgTap(e) {
        console.log(e, 'delete');
        let images = e.detail.all;
        let index = e.currentTarget.dataset.index;
        let scoring = this.data.scoring;
        scoring.detail[index].image_url = images;
        this.setData({
            scoring: scoring
        });
        console.log(this.data.scoring);
    },
    uploadImgs(images) {
        return new Promise((resolve) => {
        });
        console.log(images);
    },
    onImgChangeTap(e) {
        console.log(e);
        let images = e.detail.current;
        let scoring = this.data.scoring;
        let index = e.currentTarget.dataset.index;
        net_service_1.default.uploadImgs(images).then((res) => {
            scoring.detail[index].image_url = [...scoring.detail[index].image_url, ...res];
            this.setData({
                scoring: scoring
            });
        }, (err) => {
            this.setData({
                scoring: scoring
            });
        });
    },
    textInput(e) {
        let text = e.detail.value;
        let index = e.currentTarget.dataset.index;
        let scoring = this.data.scoring;
        scoring.detail[index].desc = text;
        this.setData({
            scoring: scoring
        });
    },
    check() {
        let flag = true;
        let scoring = this.data.scoring;
        scoring.detail.forEach((element) => {
            if (element.deduct_points > 0 && element.image_url.length < 1) {
                flag = false;
            }
        });
        if (!flag) {
            wx.showToast({
                title: '请为扣分项上传图片',
                icon: 'none',
                duration: 2000
            });
        }
        return flag;
    },
    calPoit() {
        let scoring = this.data.scoring;
        scoring.detail.forEach((element) => {
            element.deduct_points = 0;
            element.deduct_points = this.calcula(element);
        });
        scoring.deduct_points = 0;
        scoring.deduct_points = this.calcula(scoring);
        this.setData({
            scoring: scoring
        });
    },
    save(e) {
        wx.showLoading({
            title: '提交中'
        });
        this.calPoit();
        let canSave = this.check();
        if (!canSave) {
            return;
        }
        let patrolData = this.data.patrolData;
        patrolData['penalties'][this.data.scoring_index] = this.data.scoring;
        net_service_1.default.saveCurrentPenalties(patrolData).then((res) => {
            wx.removeStorageSync('scoring_index');
            wx.hideLoading();
            wx.navigateBack();
        });
    },
    onLoad() {
        wx.showLoading({ title: '加载中' });
        this.init();
    },
    onReady() {
    },
    onShow() {
        wx.hideLoading();
    },
    onHide() {
    },
    onUnload() {
    },
    onPullDownRefresh() {
    },
    onReachBottom() {
    },
    onShareAppMessage(opts) {
        console.log(opts.target);
        return {};
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb3JpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzY3JvcmluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlFQUFrRDtBQUNsRCxJQUFJLFFBQVEsR0FBTyxJQUFJLENBQUE7QUFDdkIsSUFBSSxDQUFDO0lBS0gsU0FBUyxFQUFNLEVBQUU7SUFDakIsSUFBSSxFQUFFO1FBQ0osVUFBVSxFQUFNLEVBQUU7UUFDbEIsT0FBTyxFQUFNLEVBQUU7UUFDZixhQUFhLEVBQUMsQ0FBQztLQUNoQjtJQUtELFlBQVksQ0FBRSxDQUFLO1FBQ2pCLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUN2QixRQUFRLEdBQUcsVUFBVSxDQUFDLEdBQUUsRUFBRTtZQUN4QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQTtZQUM1QixJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBQyxDQUFDLENBQUE7WUFNcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxHQUFDLGFBQWEsQ0FBQTtZQUN4RyxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLE9BQU8sRUFBRSxJQUFJO2FBQ2QsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxFQUFDLElBQUksQ0FBQyxDQUFBO0lBRVQsQ0FBQztJQUNELE9BQU8sQ0FBRSxHQUFPO1FBQ2QsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLGFBQWEsR0FBQyxDQUFDLENBQUE7UUFDL0IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFXLEVBQUUsRUFBRTtZQUNqQyxLQUFLLEdBQUcsT0FBTyxDQUFDLGFBQWEsR0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFBO1FBQ3pDLENB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RUFBQyxLQUFLLEVBQUMsQ0FBQyxDQUFBO1FBQzdCLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFLRCxPQUFPO0lBRVAsQ0FBQztJQUtELE1BQU07UUFDSixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDbEIsQ0FBQztJQUtELE1BQU07SUFFTixDQUFDO0lBS0QsUUFBUTtJQUVSLENBQUM7SUFLRCxpQkFBaUI7SUFFakIsQ0FBQztJQUtELGFBQWE7SUFFYixDQUFDO0lBS0QsaUJBQWlCLENBQUMsSUFBUTtRQUN4QixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUN4QixPQUFPLEVBQUUsQ0FBQTtJQUNYLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXBpIGZyb20gJy4uLy4uLy4uLy4uL3NlcnZpY2UvbmV0LnNlcnZpY2UnO1xyXG5sZXQgaW50ZXJ2YWw6YW55ID0gbnVsbFxyXG5QYWdlKHtcclxuXHJcbiAgLyoqXHJcbiAgICog6aG16Z2i55qE5Yid5aeL5pWw5o2uXHJcbiAgICovXHJcbiAgc2NvcmVMaXN0Ojxhbnk+e30sXHJcbiAgZGF0YToge1xyXG4gICAgcGF0cm9sRGF0YTo8YW55Pnt9LFxyXG4gICAgc2NvcmluZzo8YW55Pnt9LFxyXG4gICAgc2NvcmluZ19pbmRleDowLFxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yqg6L29XHJcbiAgICovXHJcbiAgYmluZEtleUlucHV0IChlOmFueSkge1xyXG4gICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbClcclxuICAgIGludGVydmFsID0gc2V0VGltZW91dCgoKT0+e1xyXG4gICAgICBsZXQgdGVtcCA9IHRoaXMuZGF0YS5zY29yaW5nXHJcbiAgICAgIGxldCBkZWR1Y3RfcG9pbnRzID0gZS5kZXRhaWwudmFsdWUvMVxyXG4gICAgICAvLyBkZWJ1Z2dlclxyXG4gICAgICAvLyBsZXQgcG9pbnQgPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5wb2ludC8xXHJcbiAgICAgIC8vIGlmICgoZGVkdWN0X3BvaW50cyk+KHBvaW50KSkge1xyXG4gICAgICAvLyAgIGRlZHVjdF9wb2ludHMgPSBwb2ludFxyXG4gICAgICAvLyB9XHJcbiAgICAgIHRlbXAuZGV0YWlsW2UuY3VycmVudFRhcmdldC5kYXRhc2V0LmluZGV4XS5kZXRhaWxbZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaV0uZGVkdWN0X3BvaW50cz1kZWR1Y3RfcG9pbnRzXHJcbiAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgc2NvcmluZzogdGVtcFxyXG4gICAgICB9KVxyXG4gICAgfSwxMDAwKVxyXG4gICAgXHJcbiAgfSxcclxuICBjYWxjdWxhIChzdWI6YW55KSB7XHJcbiAgICBsZXQgdG90YWwgPSBzdWIuZGVkdWN0X3BvaW50cy8xXHJcbiAgICBzdWIuZGV0YWlsLmZvckVhY2goKGVsZW1lbnQ6YW55KSA9PiB7XHJcbiAgICAgIHRvdGFsID0gZWxlbWVudC5kZWR1Y3RfcG9pbnRzLzEgKyB0b3RhbFxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdG90YWxcclxuICB9LFxyXG4gIGluaXQgKCkge1xyXG4gICAgYXBpLmdldEN1cnJlbnRQZW5hbHRpZXMoXCJjb21tdW5pdHlcIikudGhlbigocmVzOmFueSk9PntcclxuICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICBwYXRyb2xEYXRhOiByZXNcclxuICAgICAgfSlcclxuICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICBzY29yaW5nX2luZGV4OiB3eC5nZXRTdG9yYWdlU3luYygnc2NvcmluZ19pbmRleCcpLFxyXG4gICAgICB9KVxyXG4gICAgICBsZXQgc2NvcmluZyA9IHRoaXMuZGF0YS5wYXRyb2xEYXRhLnBlbmFsdGllc1t0aGlzLmRhdGEuc2NvcmluZ19pbmRleF1cclxuICAgICAgc2NvcmluZy5kZXRhaWwuZm9yRWFjaCgoZWxlbWVudDphbnkpID0+IHtcclxuICAgICAgICBlbGVtZW50LmRlZHVjdF9wb2ludHMgPSAwO1xyXG4gICAgICB9KTtcclxuICAgICAgc2NvcmluZy5kZWR1Y3RfcG9pbnRzID0gMDtcclxuICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICBzY29yaW5nOiBzY29yaW5nXHJcbiAgICAgIH0pXHJcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMuZGF0YSlcclxuICAgIH0pXHJcbiAgfSxcclxuICBvblJlbW92ZUltZ1RhcCAoZTphbnkpIHtcclxuICAgIGNvbnNvbGUubG9nKGUsJ2RlbGV0ZScpXHJcbiAgICBsZXQgaW1hZ2VzID0gZS5kZXRhaWwuYWxsXHJcbiAgICBsZXQgaW5kZXggPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pbmRleFxyXG4gICAgICBsZXQgc2NvcmluZyA9IHRoaXMuZGF0YS5zY29yaW5nO1xyXG4gICAgICBzY29yaW5nLmRldGFpbFtpbmRleF0uaW1hZ2VfdXJsID0gaW1hZ2VzXHJcbiAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgc2NvcmluZzpzY29yaW5nXHJcbiAgICAgIH0pXHJcbiAgICBjb25zb2xlLmxvZyggdGhpcy5kYXRhLnNjb3JpbmcpXHJcbiAgfSxcclxuICB1cGxvYWRJbWdzIChpbWFnZXM6QXJyYXk8YW55Pikge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlICgocmVzb2x2ZSk9PntcclxuICAgICAgXHJcbiAgICB9KVxyXG4gICAgY29uc29sZS5sb2coaW1hZ2VzKVxyXG4gIH0sXHJcbiAgb25JbWdDaGFuZ2VUYXAoZTphbnkpe1xyXG4gICAgY29uc29sZS5sb2coZSlcclxuICAgIGxldCBpbWFnZXMgPSBlLmRldGFpbC5jdXJyZW50XHJcbiAgICBsZXQgc2NvcmluZyA9IHRoaXMuZGF0YS5zY29yaW5nO1xyXG4gICAgbGV0IGluZGV4ID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaW5kZXhcclxuICAgIGFwaS51cGxvYWRJbWdzKGltYWdlcykudGhlbigocmVzOmFueSk9PntcclxuICAgICAgc2NvcmluZy5kZXRhaWxbaW5kZXhdLmltYWdlX3VybCA9IFsuLi5zY29yaW5nLmRldGFpbFtpbmRleF0uaW1hZ2VfdXJsLC4uLnJlc11cclxuICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICBzY29yaW5nOnNjb3JpbmdcclxuICAgICAgfSlcclxuICAgIH0sKGVycjphbnkpID0+IHtcclxuICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICBzY29yaW5nOnNjb3JpbmdcclxuICAgICAgfSlcclxuICAgIH0pXHJcbiAgfSxcclxuICB0ZXh0SW5wdXQoZTphbnkpe1xyXG4gICAgbGV0IHRleHQgPSBlLmRldGFpbC52YWx1ZTtcclxuICAgIGxldCBpbmRleCA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0LmluZGV4XHJcbiAgICBsZXQgc2NvcmluZyA9IHRoaXMuZGF0YS5zY29yaW5nO1xyXG4gICAgc2NvcmluZy5kZXRhaWxbaW5kZXhdLmRlc2MgPSB0ZXh0XHJcbiAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICBzY29yaW5nOnNjb3JpbmdcclxuICAgIH0pXHJcbiAgfSxcclxuICAvLyB1cGxvYWRJbWFnZXMgKHNjb3Jpbmc6YW55KSB7XHJcbiAgLy8gICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpPT57XHJcbiAgLy8gICAgIGxldCBhbGwgPSAwXHJcbiAgLy8gICAgIGxldCBmaW5pc2ggPSAwXHJcbiAgLy8gICAgIHNjb3JpbmcuZGV0YWlsLmZvckVhY2goKGVsZW1lbnQ6YW55LGluZGV4Om51bWJlcikgPT4ge1xyXG4gIC8vICAgICAgIGxldCBwaWNhcnIgPSA8YW55PltdO1xyXG4gIC8vICAgICAgIGVsZW1lbnQuaW1hZ2VfdXJsLmZvckVhY2goKGltZzpzdHJpbmcsaTpudW1iZXIpID0+IHtcclxuICAvLyAgICAgICAgIGFsbCA9IGFsbCArIDFcclxuICAvLyAgICAgICAgIGFwaS51cGxvYWRGaWxlKGltZykudGhlbigocmVzOmFueSk9PntcclxuICAvLyAgICAgICAgICAgICBsZXQgdXJsID0gSlNPTi5wYXJzZShyZXMuZGF0YSkucmVzdWx0TGlzdFswXS5hY2Nlc3NfdXJsXHJcbiAgLy8gICAgICAgICAgICAgcGljYXJyLnB1c2godXJsKVxyXG4gIC8vICAgICAgICAgICAgIGZpbmlzaCA9IGZpbmlzaCArIDFcclxuICAvLyAgICAgICAgICAgICBpZihpID09PSBlbGVtZW50LmltYWdlX3VybC5sZW5ndGgtMSkge1xyXG4gIC8vICAgICAgICAgICAgICAgZWxlbWVudC5pbWFnZV91cmwgPSBwaWNhcnI7XHJcbiAgLy8gICAgICAgICAgICAgfVxyXG4gIC8vICAgICAgICAgICAgIGlmIChhbGwgPT09IGZpbmlzaCkge1xyXG4gIC8vICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAvLyAgICAgICAgICAgICAgICAgc2NvcmluZzpzY29yaW5nXHJcbiAgLy8gICAgICAgICAgICAgICB9KVxyXG4gIC8vICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKVxyXG4gIC8vICAgICAgICAgICAgIH1cclxuICAvLyAgICAgICAgIH0pXHJcbiAgLy8gICAgICAgfSk7XHJcbiAgLy8gICAgIH0pO1xyXG4gIC8vICAgICBpZiAoYWxsID09PSAwKSB7XHJcbiAgLy8gICAgICAgcmVzb2x2ZSh0cnVlKVxyXG4gIC8vICAgICB9XHJcbiAgLy8gICB9KVxyXG4gIC8vIH0sXHJcbiAgY2hlY2sgKCkge1xyXG4gICAgLy8g5aaC5p6c5omj5YiG5LqG5rKh5pyJ5LiK5Lyg5Zu+54mHLOe7iOatolxyXG4gICAgbGV0IGZsYWcgPSB0cnVlXHJcbiAgICBsZXQgc2NvcmluZyA9IHRoaXMuZGF0YS5zY29yaW5nXHJcbiAgICBzY29yaW5nLmRldGFpbC5mb3JFYWNoKChlbGVtZW50OmFueSkgPT4ge1xyXG4gICAgICBpZiAoZWxlbWVudC5kZWR1Y3RfcG9pbnRzPjAmJmVsZW1lbnQuaW1hZ2VfdXJsLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICBmbGFnID0gZmFsc2VcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBpZiAoIWZsYWcpIHtcclxuICAgICAgd3guc2hvd1RvYXN0KHtcclxuICAgICAgICB0aXRsZTon6K+35Li65omj5YiG6aG55LiK5Lyg5Zu+54mHJyxcclxuICAgICAgICBpY29uOidub25lJyxcclxuICAgICAgICBkdXJhdGlvbjoyMDAwXHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmxhZztcclxuICB9LFxyXG4gIGNhbFBvaXQgKCkge1xyXG4gICAgbGV0IHNjb3JpbmcgPSB0aGlzLmRhdGEuc2NvcmluZ1xyXG4gICAgc2NvcmluZy5kZXRhaWwuZm9yRWFjaCgoZWxlbWVudDphbnkpID0+IHtcclxuICAgICAgZWxlbWVudC5kZWR1Y3RfcG9pbnRzID0gMFxyXG4gICAgICBlbGVtZW50LmRlZHVjdF9wb2ludHMgPSB0aGlzLmNhbGN1bGEoZWxlbWVudClcclxuICAgIH0pO1xyXG4gICAgc2NvcmluZy5kZWR1Y3RfcG9pbnRzID0gMFxyXG4gICAgc2NvcmluZy5kZWR1Y3RfcG9pbnRzID0gdGhpcy5jYWxjdWxhKHNjb3JpbmcpO1xyXG4gICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgc2NvcmluZzpzY29yaW5nXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgc2F2ZShlOmFueSl7XHJcbiAgICB3eC5zaG93TG9hZGluZyh7XHJcbiAgICAgIHRpdGxlOifmj5DkuqTkuK0nXHJcbiAgICB9KVxyXG4gICAgdGhpcy5jYWxQb2l0KClcclxuICAgIGxldCBjYW5TYXZlID0gdGhpcy5jaGVjaygpO1xyXG4gICAgaWYgKCFjYW5TYXZlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBwYXRyb2xEYXRhOmFueSA9IHRoaXMuZGF0YS5wYXRyb2xEYXRhXHJcbiAgICBwYXRyb2xEYXRhWydwZW5hbHRpZXMnXVt0aGlzLmRhdGEuc2NvcmluZ19pbmRleF0gPSB0aGlzLmRhdGEuc2NvcmluZ1xyXG4gICAgYXBpLnNhdmVDdXJyZW50UGVuYWx0aWVzKHBhdHJvbERhdGEpLnRoZW4oKHJlczphbnkpPT57XHJcbiAgICAgIHd4LnJlbW92ZVN0b3JhZ2VTeW5jKCdzY29yaW5nX2luZGV4Jyk7XHJcbiAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XHJcbiAgICAgIHd4Lm5hdmlnYXRlQmFjaygpXHJcbiAgICB9KVxyXG4gIH0sXHJcbiAgb25Mb2FkKCkge1xyXG4gICAgd3guc2hvd0xvYWRpbmcoe3RpdGxlOifliqDovb3kuK0nfSlcclxuICAgIHRoaXMuaW5pdCgpO1xyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yid5qyh5riy5p+T5a6M5oiQXHJcbiAgICovXHJcbiAgb25SZWFkeSgpIHtcclxuICAgIFxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5pi+56S6XHJcbiAgICovXHJcbiAgb25TaG93KCkge1xyXG4gICAgd3guaGlkZUxvYWRpbmcoKVxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i6ZqQ6JePXHJcbiAgICovXHJcbiAgb25IaWRlKCkge1xyXG4gICAgXHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLljbjovb1cclxuICAgKi9cclxuICBvblVubG9hZCgpIHtcclxuICAgIFxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXHJcbiAgICovXHJcbiAgb25QdWxsRG93blJlZnJlc2goKSB7XHJcbiAgICBcclxuICB9LFxyXG5cclxuICAvKipcclxuICAgKiDpobXpnaLkuIrmi4nop6blupXkuovku7bnmoTlpITnkIblh73mlbBcclxuICAgKi9cclxuICBvblJlYWNoQm90dG9tKCkge1xyXG4gICAgXHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICog55So5oi354K55Ye75Y+z5LiK6KeS5YiG5LqrXHJcbiAgICovXHJcbiAgb25TaGFyZUFwcE1lc3NhZ2Uob3B0czphbnkpOiBXZWNoYXRNaW5pcHJvZ3JhbS5QYWdlLklDdXN0b21TaGFyZUNvbnRlbnQge1xyXG4gICAgY29uc29sZS5sb2cob3B0cy50YXJnZXQpXHJcbiAgICByZXR1cm4ge31cclxuICB9XHJcbn0pIl19